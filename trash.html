<script>
        (function () {

            function fmt(x) { return Number(x).toLocaleString('ar-SA', { maximumFractionDigits: 2 }); }
            function num(v) { return Number((v || 0)); }

            const aEl = document.getElementById('A');
            const bEl = document.getElementById('B');
            const cEl = document.getElementById('C');
            const eEl = document.getElementById('E');

            const loanCeilingInput = document.getElementById('loanCeilingInput');
            const customLoanInput = document.getElementById('customLoanInput');
            const monthlyByTable = document.getElementById('monthlyByTable');
            const monthsEl = document.getElementById('months');

            const calcBtn = document.getElementById('calcBtn');
            const resetBtn = document.getElementById('resetBtn');
            const exportPDF = document.getElementById('exportPDF');

            const output = document.getElementById('output');
            const maxLoanDisplay = document.getElementById('maxLoanDisplay');
            const monthlyDisplay = document.getElementById('monthlyDisplay');
            const totalPaymentDisplay = document.getElementById('totalPaymentDisplay');
            const amortTableBody = document.querySelector('#amortTable tbody');
            const noteText = document.getElementById('noteText');

            window.lastSchedule = null;

            function monthlyFromAmount(amount) {
                if (amount >= 500 && amount <= 5000) return 500;
                if (amount <= 10000) return 1000;
                if (amount <= 20000) return 1500;
                if (amount <= 30000) return 2000;
                if (amount <= 35000) return 2500;
                if (amount <= 40000) return 3000;
                if (amount <= 45000) return 3500;
                if (amount <= 50000) return 4000;
                return null;
            }

            function amortizeNoInterest(principal, monthlyPayment) {
                const schedule = [];
                const months = Math.ceil(principal / monthlyPayment);
                let balance = principal;
                for (let i = 1; i <= months; i++) {
                    let payment = (i === months) ? balance : monthlyPayment;
                    let before = balance;
                    balance = Math.max(0, balance - payment);
                    schedule.push({ installment: i, before, payment, after: balance });
                }
                return schedule;
            }

            function buildTable(schedule) {
                amortTableBody.innerHTML = '';
                schedule.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${r.installment}</td>
                <td>${r.dateFormatted}</td>
                <td>${fmt(r.payment)}</td>
                <td>${fmt(r.after)}</td>
            `;
                    amortTableBody.appendChild(tr);
                });
            }

            function computeAndRender() {
                const A = num(aEl.value), B = num(bEl.value), C = num(cEl.value), E = num(eEl.value);
                const total = A + B + C;
                const byContribution = total * 5;
                const reserve = E * 0.10;
                const available = E - reserve;
                const byPool = available / 5;
                let ceiling = Math.min(byContribution, byPool, available);
                ceiling = Math.min(ceiling, 35000);

                if (ceiling < 500) {
                    alert("عذراً — لا توجد أهلية للقرض وفق المعطيات.");
                    return;
                }

                let finalLoan = ceiling;
                const custom = num(customLoanInput.value);
                if (custom > 0) {
                    if (custom > ceiling) { alert("المبلغ المدخل أكبر من السقف."); return; }
                    if (custom < 500) { alert("الحد الأدنى للقرض 500."); return; }
                    finalLoan = custom;
                }

                const monthly = monthlyFromAmount(finalLoan);
                if (!monthly) {
                    alert("لا يوجد قسط مناسب للمبلغ.");
                    return;
                }

                const schedule = amortizeNoInterest(finalLoan, monthly);
                const totalPay = schedule.reduce((s, r) => s + r.payment, 0);
                const months = schedule.length;

                const monthsArabic = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                const start = new Date();
                start.setMonth(start.getMonth() + 1);
                let d = new Date(start);

                schedule.forEach(r => {
                    r.dateFormatted = `${d.getDate()} ${monthsArabic[d.getMonth()]} ${d.getFullYear()}`;
                    d.setMonth(d.getMonth() + 1);
                });

                window.lastSchedule = { ceiling: finalLoan, monthlyPayment: monthly, months, schedule };

                output.style.display = 'block';
                maxLoanDisplay.textContent = fmt(finalLoan) + " ﷼";
                monthlyDisplay.textContent = fmt(monthly) + " ﷼";
                totalPaymentDisplay.textContent = fmt(totalPay) + " ﷼";
                loanCeilingInput.value = fmt(ceiling) + " ﷼";
                monthlyByTable.value = fmt(monthly) + " ﷼";
                monthsEl.value = months + " شهر";
                noteText.innerHTML = `يتم السداد على ${months} شهرًا بقسط ${fmt(monthly)} ﷼.`;

                buildTable(schedule);
            }

            calcBtn.addEventListener('click', computeAndRender);

            resetBtn.addEventListener('click', () => {
                aEl.value = bEl.value = cEl.value = 0;
                eEl.value = 90000;
                customLoanInput.value = '';
                output.style.display = 'none';
                amortTableBody.innerHTML = '';
                window.lastSchedule = null;
            });

            // ✅ Export PDF — Multi-page — Arabic-safe
            exportPDF.addEventListener("click", async () => {
                if (!window.lastSchedule) {
                    alert("قم بالحساب أولاً.");
                    return;
                }

                const element = document.getElementById("output");
                const { jsPDF } = window.jspdf;

                const canvas = await html2canvas(element, { scale: 3, useCORS: true });
                const imgData = canvas.toDataURL("image/png");

                const pdf = new jsPDF("p", "mm", "a4");
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save("loan_result.pdf");
            });

        })();
    </script>